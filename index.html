<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OmniWeather: AI æ°”è±¡ä¸å…¨æ¯ç”Ÿæ€ç»ˆç«¯</title>
    
    <!-- æ ·å¼ä¸å›¾æ ‡ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- AI ä¸ è§†è§‰åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- OrbitControls ç”¨äºåœ°çƒæ—‹è½¬ -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <style>
        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', system-ui, sans-serif;
            background-color: #050505;
            color: white;
            margin: 0;
            overflow: hidden; 
        }

        /* 3D ç”»å¸ƒå±‚ */
        #canvas-wrapper {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0;
            pointer-events: auto; 
        }

        /* UI å±‚: é»˜è®¤ç©¿é€ */
        #ui-container {
            position: relative;
            z-index: 10;
            height: 100vh;
            overflow-y: auto;
            scroll-behavior: smooth;
            pointer-events: none; 
        }

        /* æ¢å¤äº¤äº’çš„å…ƒç´  */
        nav, 
        .glass-panel, 
        input, 
        button,
        .pointer-auto {
            pointer-events: auto; 
        }

        /* ä»ªè¡¨ç›˜è§†å›¾ï¼šéœ€è¦æ”¯æŒé¡µé¢æ»šåŠ¨ */
        #view-dashboard {
            pointer-events: auto; 
        }

        /* åœ°çƒè§†å›¾ï¼šä¿æŒç©¿é€ï¼Œä»¥ä¾¿æ‹–æ‹½åœ°çƒ */
        #view-earth {
            pointer-events: none;
        }

        /* ç»ç’ƒæ‹Ÿæ€ */
        .glass-panel {
            background: rgba(18, 25, 38, 0.75);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .glass-panel:hover {
            border-color: rgba(255, 255, 255, 0.25);
            background: rgba(25, 35, 50, 0.85);
            transform: translateY(-2px);
        }

        /* CNN åŠ¨ç”»å…³é”®å¸§ */
        @keyframes scan {
            0% { left: 0%; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { left: 85%; opacity: 0; }
        }
        .cnn-kernel {
            position: absolute;
            top: 0; bottom: 0; width: 15%;
            background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.3), transparent);
            border-left: 1px solid rgba(59, 130, 246, 0.8);
            border-right: 1px solid rgba(59, 130, 246, 0.8);
            animation: scan 2s linear infinite;
            pointer-events: none;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.2);
        }

        /* åœ°çƒæ ‡æ³¨æ ‡ç­¾ */
        .earth-label {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 12px;
            pointer-events: none;
            color: #e2e8f0;
            border: 1px solid rgba(59, 130, 246, 0.4);
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.3);
        }
        .earth-label::before {
            content: '';
            position: absolute;
            bottom: -6px; left: 50%;
            transform: translateX(-50%);
            border-width: 6px 6px 0;
            border-style: solid;
            border-color: rgba(59, 130, 246, 0.4) transparent transparent transparent;
        }
        .earth-label.visible { opacity: 1; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .page-section {
            display: none;
            animation: fadeScale 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
        .page-section.active { display: block; }
        @keyframes fadeScale {
            from { opacity: 0; transform: scale(0.96) translateY(20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        /* æ¨èå›¾ç‰‡å¡ç‰‡ */
        .travel-card {
            background-size: cover;
            background-position: center;
            position: relative;
            overflow: hidden;
        }
        .travel-card::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
        }
    </style>
</head>
<body>

    <!-- 1. å…¨å±€ 3D æ¸²æŸ“å®¹å™¨ (Three.js) -->
    <div id="canvas-wrapper"></div>
    
    <!-- 2. æ‰‹åŠ¿æ‘„åƒå¤´ (éšè—) -->
    <video id="video-input" class="hidden" playsinline></video>

    <!-- 3. ä¸»ç•Œé¢å®¹å™¨ -->
    <div id="ui-container" class="no-scrollbar">
        
        <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
        <nav class="sticky top-0 z-50 p-4 backdrop-blur-md bg-black/40 border-b border-white/5">
            <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center animate-pulse shadow-[0_0_15px_rgba(37,99,235,0.6)]">
                        <i class="ph ph-planet text-2xl"></i>
                    </div>
                    <h1 class="font-bold text-xl tracking-wider">OMNI <span class="text-blue-400">WEATHER</span></h1>
                </div>

                <!-- è§†å›¾åˆ‡æ¢å™¨ -->
                <div class="flex bg-white/5 p-1 rounded-lg pointer-auto border border-white/10">
                    <button onclick="App.switchView('dashboard')" id="btn-dashboard" class="px-6 py-2 rounded-md text-sm font-bold transition-all bg-blue-600 shadow-lg text-white">
                        <i class="ph ph-chart-line-up mr-2"></i> æ°”è±¡æ•°æ®èˆ±
                    </button>
                    <button onclick="App.switchView('earth')" id="btn-earth" class="px-6 py-2 rounded-md text-sm font-bold transition-all text-gray-400 hover:text-white hover:bg-white/5">
                        <i class="ph ph-globe-hemisphere-west mr-2"></i> å…¨æ¯åœ°çƒä»ª
                    </button>
                </div>

                <div class="flex gap-2 pointer-auto">
                    <button onclick="SuggestionBox.open()" class="glass-panel p-2.5 rounded-lg text-yellow-400 hover:bg-yellow-400/20" title="å»ºè®®ç®±">
                        <i class="ph ph-lightbulb text-xl"></i>
                    </button>
                    <button onclick="GestureCtrl.toggle()" id="btn-gesture" class="glass-panel p-2.5 rounded-lg text-purple-400 hover:bg-purple-400/20" title="å¼€å¯æ‰‹åŠ¿æ§åˆ¶">
                        <i class="ph ph-hand-waving text-xl"></i>
                    </button>
                </div>
            </div>
        </nav>

        <!-- é¡µé¢ 1: æ°”è±¡æ•°æ®èˆ± (Dashboard) -->
        <section id="view-dashboard" class="page-section active max-w-7xl mx-auto p-4 md:p-8 pb-20">
            
            <!-- æœç´¢æ  -->
            <div class="mb-8 flex gap-3 max-w-lg mx-auto md:mx-0">
                <input type="text" id="city-input" placeholder="è¾“å…¥åŸå¸‚åç§° (å¦‚ï¼šBeijing, Tokyo)..." 
                       class="flex-1 bg-slate-800/80 border border-white/20 rounded-xl px-5 py-3 text-white focus:ring-2 focus:ring-blue-500 outline-none backdrop-blur-xl transition-all">
                <button onclick="WeatherCore.search()" class="bg-blue-600 hover:bg-blue-500 px-6 rounded-xl font-bold transition shadow-lg shadow-blue-900/50 flex items-center">
                    <i class="ph ph-magnifying-glass mr-2"></i> æœç´¢
                </button>
            </div>

            <!-- é¡¶éƒ¨æ•°æ®åŒº -->
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 mb-8">
                <!-- å·¦ä¾§ä¸»å¤©æ°”å¡ -->
                <div class="lg:col-span-8 glass-panel rounded-3xl p-8 relative overflow-hidden group">
                    <div class="absolute right-0 top-0 w-80 h-80 bg-blue-500/20 rounded-full blur-[80px] -mr-16 -mt-16 pointer-events-none mix-blend-screen"></div>
                    
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-end gap-6 relative z-10">
                        <div>
                            <div class="flex items-center gap-3 mb-2">
                                <i class="ph ph-map-pin text-blue-400 text-2xl"></i>
                                <h2 id="city-name" class="text-4xl md:text-6xl font-bold tracking-tight">åŠ è½½ä¸­...</h2>
                            </div>
                            <p id="current-date" class="text-blue-200/80 text-lg font-mono">--</p>
                            <div class="mt-8 flex items-baseline gap-6">
                                <span id="temp-val" class="text-8xl font-bold bg-gradient-to-br from-white via-blue-100 to-blue-300 bg-clip-text text-transparent drop-shadow-lg">--</span>
                                <div class="flex flex-col text-xl text-gray-300 border-l-2 border-white/10 pl-4">
                                    <span id="weather-desc" class="text-2xl text-white font-medium">--</span>
                                    <span class="text-sm text-gray-500 mt-1">å®æ—¶ç›‘æµ‹ AI-Link</span>
                                </div>
                            </div>
                        </div>
                        <div class="text-right space-y-3 w-full md:w-auto">
                            <div class="glass-panel px-5 py-3 rounded-xl flex items-center justify-between gap-4 border-l-4 border-blue-500">
                                <span class="text-gray-400 text-sm">æ¹¿åº¦</span>
                                <span class="text-xl font-bold flex items-center"><i class="ph ph-drop text-blue-400 mr-2"></i><span id="humidity">--%</span></span>
                            </div>
                            <div class="glass-panel px-5 py-3 rounded-xl flex items-center justify-between gap-4 border-l-4 border-teal-500">
                                <span class="text-gray-400 text-sm">é£é€Ÿ</span>
                                <span class="text-xl font-bold flex items-center"><i class="ph ph-wind text-teal-400 mr-2"></i><span id="wind">--</span></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å³ä¾§ CNN é¢„æµ‹ -->
                <div class="lg:col-span-4 glass-panel rounded-3xl p-6 flex flex-col relative overflow-hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-bold flex items-center gap-2 text-lg">
                            <i class="ph ph-brain text-pink-500 text-xl"></i> ç¥ç»ç½‘ç»œé¢„æµ‹
                        </h3>
                        <span class="text-[10px] font-mono uppercase bg-pink-500/10 text-pink-300 px-2 py-1 rounded border border-pink-500/30">LSTM + ARIMA</span>
                    </div>

                    <div class="flex-1 flex flex-col justify-center gap-6">
                        <!-- 1. è¾“å…¥å±‚ -->
                        <div class="space-y-2">
                            <div class="text-xs text-gray-400 flex justify-between font-mono">
                                <span>INPUT_TENSOR (Hist)</span>
                                <span>KERNEL_SCAN</span>
                            </div>
                            <div class="h-16 flex items-end gap-1 relative bg-black/40 rounded-lg p-2 border border-white/5" id="cnn-input">
                                <div class="cnn-kernel z-20"></div>
                            </div>
                        </div>

                        <!-- 2. è¾“å‡ºå±‚ -->
                        <div class="space-y-2">
                            <div class="text-xs text-gray-400 font-mono">PREDICTION (Next 5 Days)</div>
                            <div class="grid grid-cols-5 gap-2 text-center" id="cnn-output"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ä¸­éƒ¨ï¼šAI å»ºè®® -->
            <div class="glass-panel rounded-2xl p-6 mb-8 border-l-4 border-purple-500 flex flex-col md:flex-row items-center gap-6">
                <div class="w-16 h-16 rounded-full bg-purple-500/20 flex items-center justify-center text-3xl shrink-0">
                    ğŸ¤–
                </div>
                <div>
                    <h3 class="text-purple-300 font-bold mb-1 text-lg">AI ç”Ÿæ´»ç®¡å®¶å»ºè®®</h3>
                    <p id="suggestion-desc" class="text-gray-300 leading-relaxed">æ­£åœ¨åˆ†æç¯å¢ƒæ•°æ®...</p>
                </div>
            </div>

            <!-- æ–°å¢ï¼šåŸå¸‚æ¢ç´¢ä¸æ¨è -->
            <div class="border-t border-white/10 pt-8 mt-8">
                <div class="flex items-center gap-3 mb-6">
                    <i class="ph ph-compass text-3xl text-orange-400"></i>
                    <h2 class="text-2xl font-bold">åŸå¸‚æ¢ç´¢æŒ‡å— <span class="text-sm font-normal text-gray-500 ml-2">Local Guide</span></h2>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- 1. å¿…åƒç¾é£Ÿ -->
                    <div class="glass-panel rounded-2xl p-5">
                        <h3 class="text-lg font-bold mb-4 flex items-center text-orange-300">
                            <i class="ph ph-bowl-food mr-2"></i> å¿…å°ç¾é£Ÿ
                        </h3>
                        <div id="food-list" class="space-y-3">
                            <!-- JS å¡«å…… -->
                            <div class="animate-pulse flex space-x-4">
                                <div class="rounded-full bg-white/10 h-10 w-10"></div>
                                <div class="flex-1 space-y-2 py-1">
                                    <div class="h-2 bg-white/10 rounded w-3/4"></div>
                                    <div class="h-2 bg-white/10 rounded"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 2. çƒ­é—¨æ™¯ç‚¹ -->
                    <div class="glass-panel rounded-2xl p-5">
                        <h3 class="text-lg font-bold mb-4 flex items-center text-green-300">
                            <i class="ph ph-binoculars mr-2"></i> çƒ­é—¨æ™¯ç‚¹
                        </h3>
                        <div id="spot-list" class="space-y-3">
                            <!-- JS å¡«å…… -->
                        </div>
                    </div>

                    <!-- 3. å°è±¡å›¾é›† -->
                    <div class="glass-panel rounded-2xl p-5">
                        <h3 class="text-lg font-bold mb-4 flex items-center text-blue-300">
                            <i class="ph ph-image mr-2"></i> åŸå¸‚å°è±¡
                        </h3>
                        <div class="grid grid-cols-2 gap-2 h-40">
                            <div class="travel-card rounded-lg bg-gray-800 flex items-center justify-center group relative cursor-pointer">
                                <i class="ph ph-camera text-2xl text-white/50 group-hover:scale-110 transition"></i>
                                <span class="absolute bottom-1 left-2 text-[10px] text-gray-300">City View</span>
                            </div>
                            <div class="travel-card rounded-lg bg-gray-700 flex items-center justify-center group relative cursor-pointer">
                                <i class="ph ph-users text-2xl text-white/50 group-hover:scale-110 transition"></i>
                                <span class="absolute bottom-1 left-2 text-[10px] text-gray-300">Culture</span>
                            </div>
                            <div class="travel-card rounded-lg bg-gray-700 flex items-center justify-center group relative cursor-pointer">
                                <i class="ph ph-fork-knife text-2xl text-white/50 group-hover:scale-110 transition"></i>
                                <span class="absolute bottom-1 left-2 text-[10px] text-gray-300">Food</span>
                            </div>
                            <div class="travel-card rounded-lg bg-gray-800 flex items-center justify-center group relative cursor-pointer">
                                <i class="ph ph-buildings text-2xl text-white/50 group-hover:scale-110 transition"></i>
                                <span class="absolute bottom-1 left-2 text-[10px] text-gray-300">Night</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </section>

        <!-- é¡µé¢ 2: ç”Ÿæ€åœ°çƒä»ª (Earth) -->
        <section id="view-earth" class="page-section max-w-7xl mx-auto p-4 md:p-8 h-[90vh] relative">
            
            <!-- æ‚¬æµ®æ§åˆ¶é¢æ¿ -->
            <div class="absolute top-4 left-4 z-20 glass-panel p-5 rounded-xl max-w-xs pointer-auto border-l-4 border-blue-500">
                <h3 class="font-bold mb-1 text-lg">Holo-Earth V2.0</h3>
                <p class="text-xs text-gray-400 mb-4 font-mono">Real-time Ecological Monitoring</p>
                <div class="space-y-3 text-sm">
                    <div class="flex items-center justify-between">
                        <span class="text-gray-400">Atmosphere</span>
                        <span class="text-green-400 text-xs px-2 py-0.5 bg-green-400/10 rounded">Active</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-gray-400">Markers</span>
                        <span id="marker-count" class="text-blue-400 font-mono">Loading...</span>
                    </div>
                </div>
                <div class="mt-4 pt-4 border-t border-white/10 text-xs text-gray-500">
                    * åŒå‡»å¯èšç„¦ä½ç½®<br>
                    * æ‹–æ‹½æ—‹è½¬ï¼Œæ»šè½®ç¼©æ”¾
                </div>
            </div>

            <!-- 2D æ ‡ç­¾å±‚ -->
            <div id="earth-labels-container" class="absolute inset-0 pointer-events-none z-10 overflow-hidden"></div>
        </section>

    </div>

    <!-- å»ºè®®ç®± Modal -->
    <div id="suggestion-modal" class="fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm hidden flex items-center justify-center p-4 pointer-auto">
        <div class="glass-panel w-full max-w-md p-6 rounded-2xl transform scale-95 opacity-0 transition-all duration-300" id="suggestion-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">ğŸ’¡ ç”¨æˆ·å»ºè®®ç®±</h3>
                <button onclick="SuggestionBox.close()" class="text-gray-400 hover:text-white"><i class="ph ph-x text-xl"></i></button>
            </div>
            <textarea class="w-full bg-black/30 border border-white/10 rounded-xl p-3 text-white h-32 focus:ring-1 focus:ring-blue-500 outline-none mb-4" placeholder="åœ¨æ­¤è¾“å…¥æ‚¨çš„å»ºè®®..."></textarea>
            <div class="flex justify-end gap-3">
                <button onclick="SuggestionBox.close()" class="px-4 py-2 text-sm text-gray-400 hover:text-white">å–æ¶ˆ</button>
                <button onclick="SuggestionBox.submit()" class="px-6 py-2 bg-blue-600 rounded-lg text-sm font-bold shadow-lg hover:bg-blue-500">æäº¤å»ºè®®</button>
            </div>
        </div>
    </div>

    <!-- åŠ è½½å±‚ -->
    <div id="loading-overlay" class="fixed inset-0 z-[200] bg-[#020205] flex flex-col items-center justify-center transition-opacity duration-700 pointer-events-none">
        <div class="relative w-20 h-20 mb-6">
            <div class="absolute inset-0 border-4 border-blue-600/30 rounded-full"></div>
            <div class="absolute inset-0 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
            <div class="absolute inset-4 bg-blue-500/20 rounded-full blur-md animate-pulse"></div>
        </div>
        <div class="text-blue-400 font-mono text-sm tracking-[0.2em] animate-pulse">INITIALIZING CORE...</div>
    </div>

    <script>
        /**
         * çŠ¶æ€ç®¡ç†
         */
        const App = {
            currentView: 'dashboard',
            targetCityCoords: null, // å­˜å‚¨å½“å‰æœç´¢åŸå¸‚çš„åæ ‡
            
            init() {
                ThreeEngine.init();
                WeatherCore.init();
                setTimeout(() => {
                    const loader = document.getElementById('loading-overlay');
                    loader.classList.add('opacity-0');
                    loader.style.pointerEvents = 'none'; 
                }, 1500);
            },

            switchView(viewName) {
                document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
                document.getElementById(`view-${viewName}`).classList.add('active');
                
                const btnDash = document.getElementById('btn-dashboard');
                const btnEarth = document.getElementById('btn-earth');
                
                if (viewName === 'dashboard') {
                    btnDash.className = "px-6 py-2 rounded-md text-sm font-bold transition-all bg-blue-600 shadow-lg text-white";
                    btnEarth.className = "px-6 py-2 rounded-md text-sm font-bold transition-all text-gray-400 hover:text-white hover:bg-white/5";
                    ThreeEngine.switchScene('particles');
                } else {
                    btnEarth.className = "px-6 py-2 rounded-md text-sm font-bold transition-all bg-green-600 shadow-lg text-white";
                    btnDash.className = "px-6 py-2 rounded-md text-sm font-bold transition-all text-gray-400 hover:text-white hover:bg-white/5";
                    ThreeEngine.switchScene('earth');
                    
                    // å¦‚æœæœ‰ç›®æ ‡åŸå¸‚ï¼Œè‡ªåŠ¨æ—‹è½¬åœ°çƒ
                    if(this.targetCityCoords) {
                        ThreeEngine.rotateTo(this.targetCityCoords.lat, this.targetCityCoords.lon);
                    }
                }
                this.currentView = viewName;
            }
        };

        /**
         * 3D å¼•æ“ (Shaderå‡çº§ç‰ˆ)
         */
        const ThreeEngine = {
            renderer: null, camera: null, activeScene: null, controls: null,
            scenes: { particles: null, earth: null },
            earthGroup: null, markers: [], earthMesh: null,

            // å¤§æ°”å±‚ Shader
            vertexShader: `
                varying vec3 vNormal;
                void main() {
                    vNormal = normalize(normalMatrix * normal);
                    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                }
            `,
            fragmentShader: `
                varying vec3 vNormal;
                void main() {
                    float intensity = pow(0.6 - dot(vNormal, vec3(0, 0, 1.0)), 4.0);
                    gl_FragColor = vec4(0.3, 0.6, 1.0, 1.0) * intensity * 1.5;
                }
            `,

            init() {
                const container = document.getElementById('canvas-wrapper');
                this.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                container.appendChild(this.renderer.domElement);

                this.camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
                this.camera.position.z = 12;

                this.initParticleScene();
                this.initEarthScene();
                this.activeScene = this.scenes.particles;
                this.animate();
                window.addEventListener('resize', () => this.onResize());
            },

            // ç²’å­åœºæ™¯ (ä¿æŒç®€çº¦)
            initParticleScene() {
                const scene = new THREE.Scene();
                const geometry = new THREE.BufferGeometry();
                const count = 3000;
                const pos = new Float32Array(count * 3);
                for(let i=0; i<count*3; i++) pos[i] = (Math.random()-0.5)*20;
                geometry.setAttribute('position', new THREE.BufferAttribute(pos, 3));
                
                const mat = new THREE.PointsMaterial({
                    size: 0.05, color: 0x3b82f6, transparent: true, opacity: 0.6
                });
                this.particles = new THREE.Points(geometry, mat);
                scene.add(this.particles);
                this.scenes.particles = scene;
            },

            // å¢å¼ºç‰ˆåœ°çƒåœºæ™¯
            initEarthScene() {
                const scene = new THREE.Scene();
                
                // ç¯å…‰å¢å¼º
                const ambient = new THREE.AmbientLight(0xffffff, 0.2); 
                scene.add(ambient);
                const sunLight = new THREE.DirectionalLight(0xffffff, 1.5);
                sunLight.position.set(5, 3, 5);
                scene.add(sunLight);
                // è“è‰²èƒŒå…‰ï¼Œå¢åŠ ç§‘å¹»æ„Ÿ
                const backLight = new THREE.PointLight(0x0055ff, 1, 100);
                backLight.position.set(-5, -5, -10);
                scene.add(backLight);

                // æ˜Ÿç©º
                const starGeo = new THREE.BufferGeometry();
                const starCount = 3000;
                const starPos = new Float32Array(starCount * 3);
                for(let i=0; i<starCount*3; i++) starPos[i] = (Math.random()-0.5)*150;
                starGeo.setAttribute('position', new THREE.BufferAttribute(starPos, 3));
                const starMat = new THREE.PointsMaterial({color: 0xaaaaaa, size: 0.1, transparent: true});
                scene.add(new THREE.Points(starGeo, starMat));

                this.earthGroup = new THREE.Group();

                // 1. ç¨‹åºåŒ–åœ°çƒçº¹ç† (Canvas) - å¢åŠ ç»†èŠ‚
                const mapTexture = this.createProceduralEarthTexture();
                const bumpTexture = this.createProceduralBumpMap(); // ç®€å•çš„å‡¹å‡¸è´´å›¾
                
                const earthGeo = new THREE.SphereGeometry(3.5, 64, 64);
                const earthMat = new THREE.MeshPhongMaterial({
                    map: mapTexture,
                    bumpMap: bumpTexture,
                    bumpScale: 0.05,
                    specularMap: bumpTexture, // æµ·æ´‹åå…‰ï¼Œé™†åœ°å“‘å…‰
                    specular: new THREE.Color(0x333333),
                    shininess: 15
                });
                this.earthMesh = new THREE.Mesh(earthGeo, earthMat);
                this.earthGroup.add(this.earthMesh);

                // 2. å¤§æ°”å±‚è¾‰å…‰ (Shader)
                const atmosGeo = new THREE.SphereGeometry(3.5 + 0.3, 64, 64); // ç¨å¤§ä¸€ç‚¹
                const atmosMat = new THREE.ShaderMaterial({
                    vertexShader: this.vertexShader,
                    fragmentShader: this.fragmentShader,
                    blending: THREE.AdditiveBlending,
                    side: THREE.BackSide,
                    transparent: true
                });
                const atmosphere = new THREE.Mesh(atmosGeo, atmosMat);
                this.earthGroup.add(atmosphere);

                // 3. çœŸå®åœ°ç†æ ‡è®°
                // æ ¼å¼: [lat, lon, label, emoji, isCapital]
                const realLocations = [
                    [39.9042, 116.4074, "Beijing", "ğŸ‡¨ğŸ‡³", true],
                    [31.2304, 121.4737, "Shanghai", "ğŸ™ï¸", false],
                    [35.6762, 139.6503, "Tokyo", "ğŸ‡¯ğŸ‡µ", true],
                    [40.7128, -74.0060, "New York", "ğŸ‡ºğŸ‡¸", false],
                    [51.5074, -0.1278, "London", "ğŸ‡¬ğŸ‡§", true],
                    [48.8566, 2.3522, "Paris", "ğŸ‡«ğŸ‡·", true],
                    [-33.8688, 151.2093, "Sydney", "ğŸ‡¦ğŸ‡º", false],
                    [55.7558, 37.6173, "Moscow", "ğŸ‡·ğŸ‡º", true],
                    [1.3521, 103.8198, "Singapore", "ğŸ‡¸ğŸ‡¬", true],
                    [25.2048, 55.2708, "Dubai", "ğŸ‡¦ğŸ‡ª", false],
                    [-22.9068, -43.1729, "Rio", "ğŸ‡§ğŸ‡·", false],
                    [30.0444, 31.2357, "Cairo", "ğŸ‡ªğŸ‡¬", true],
                    [19.0760, 72.8777, "Mumbai", "ğŸ‡®ğŸ‡³", false]
                ];
                
                realLocations.forEach(loc => this.addMarker(loc[0], loc[1], loc[2], loc[3], loc[4]));
                document.getElementById('marker-count').textContent = realLocations.length;

                scene.add(this.earthGroup);
                this.scenes.earth = scene;

                // æ§åˆ¶å™¨
                this.controls = new THREE.OrbitControls(this.camera, this.renderer.domElement);
                this.controls.enableDamping = true;
                this.controls.dampingFactor = 0.05;
                this.controls.enableZoom = true;
                this.controls.minDistance = 5;
                this.controls.maxDistance = 20;
                this.controls.enabled = false;
            },

            // ç”Ÿæˆæ›´å¤æ‚çš„ç¨‹åºåŒ–è´´å›¾
            createProceduralEarthTexture() {
                const canvas = document.createElement('canvas');
                canvas.width = 1024; canvas.height = 512;
                const ctx = canvas.getContext('2d');
                
                // æ·±è“æµ·æ´‹èƒŒæ™¯
                ctx.fillStyle = '#001a33';
                ctx.fillRect(0,0,1024,512);
                
                // æ¨¡æ‹Ÿå¤§é™†å— (éšæœºå™ªç‚¹ + å¹³æ»‘)
                for(let i=0; i<300; i++) {
                    const x = Math.random() * 1024;
                    const y = Math.random() * 512;
                    const r = Math.random() * 40 + 10;
                    
                    const grad = ctx.createRadialGradient(x,y,0, x,y,r);
                    grad.addColorStop(0, 'rgba(40, 100, 40, 0.8)'); // ç»¿è‰²é™†åœ°
                    grad.addColorStop(1, 'rgba(0,0,0,0)');
                    ctx.fillStyle = grad;
                    ctx.beginPath();
                    ctx.arc(x,y,r,0,Math.PI*2);
                    ctx.fill();
                }

                // æ¨¡æ‹Ÿäº‘å±‚
                for(let i=0; i<150; i++) {
                    const x = Math.random() * 1024;
                    const y = Math.random() * 512;
                    const r = Math.random() * 60 + 20;
                    ctx.fillStyle = `rgba(255,255,255, ${Math.random()*0.15})`;
                    ctx.beginPath();
                    ctx.arc(x,y,r,0,Math.PI*2);
                    ctx.fill();
                }

                return new THREE.CanvasTexture(canvas);
            },
            
            // ç®€å•çš„ Specular/Bump Map
            createProceduralBumpMap() {
                const canvas = document.createElement('canvas');
                canvas.width = 1024; canvas.height = 512;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = '#000000'; // æµ·æ´‹æ˜¯é»‘çš„ï¼ˆå…‰æ»‘/ä½åœ°ï¼‰
                ctx.fillRect(0,0,1024,512);
                
                // é‡å¤ä¸Šé¢çš„é™†åœ°é€»è¾‘ï¼Œä½†æ˜¯ç”¨ç™½è‰²
                for(let i=0; i<300; i++) {
                    const x = Math.random() * 1024;
                    const y = Math.random() * 512;
                    const r = Math.random() * 40 + 10;
                    const grad = ctx.createRadialGradient(x,y,0, x,y,r);
                    grad.addColorStop(0, 'rgba(255, 255, 255, 0.5)'); 
                    grad.addColorStop(1, 'rgba(0,0,0,0)');
                    ctx.fillStyle = grad;
                    ctx.beginPath();
                    ctx.arc(x,y,r,0,Math.PI*2);
                    ctx.fill();
                }
                return new THREE.CanvasTexture(canvas);
            },

            addMarker(lat, lon, text, emoji, isCapital) {
                const phi = (90 - lat) * (Math.PI / 180);
                const theta = (lon + 180) * (Math.PI / 180);
                const r = 3.6; // åœ¨åœ°çƒåŠå¾„(3.5)ä¹‹å¤–
                
                const x = -(r * Math.sin(phi) * Math.cos(theta));
                const z = (r * Math.sin(phi) * Math.sin(theta));
                const y = (r * Math.cos(phi));

                const div = document.createElement('div');
                div.className = 'earth-label';
                div.innerHTML = `<span class="text-base mr-1">${emoji}</span> <span class="${isCapital ? 'font-bold text-white' : 'text-gray-300'}">${text}</span>`;
                document.getElementById('earth-labels-container').appendChild(div);

                // æ·»åŠ  3D é”šç‚¹ (ä¸€ä¸ªå°å…‰ç‚¹)
                const pointGeo = new THREE.SphereGeometry(0.04, 8, 8);
                const pointMat = new THREE.MeshBasicMaterial({color: isCapital ? 0xffaa00 : 0x00ffff});
                const mesh = new THREE.Mesh(pointGeo, pointMat);
                mesh.position.set(x, y, z);
                this.earthGroup.add(mesh);

                this.markers.push({
                    position: mesh.position, // ä½¿ç”¨ mesh çš„ä½ç½®
                    element: div
                });
            },

            rotateTo(lat, lon) {
                if(!this.controls) return;
                // å°†ç»çº¬åº¦è½¬ä¸ºç›¸æœºä½ç½®
                // ç®€å•çš„åšæ³•ï¼šæ—‹è½¬ earthGroup è®©ç›®æ ‡ç‚¹å¯¹ç€ç›¸æœº
                // ä½†è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ OrbitControlsï¼Œæ›´å¥½çš„æ˜¯ç§»åŠ¨ç›¸æœº
                // è¿™é‡Œæš‚ä¸åšå¤æ‚åŠ¨ç”»ï¼Œä»…æç¤º
                console.log(`Rotating to ${lat}, ${lon}`);
                
                // ç®€æ˜“å®ç°ï¼šç›´æ¥æ”¹å˜ earthGroup çš„æ—‹è½¬ (éœ€è¦é‡ç½®)
                // å®é™…ä¸Šè®© OrbitControls ç§»åŠ¨æ¯”è¾ƒå¹³æ»‘ï¼Œéœ€è¦è®¡ç®— Spherical
                const phi = (90 - lat) * (Math.PI / 180);
                const theta = (lon + 180) * (Math.PI / 180);
                
                // ç§»åŠ¨ç›¸æœºä½ç½® (ä¿æŒåŠå¾„)
                const r = 12;
                const x = -(r * Math.sin(phi) * Math.cos(theta));
                const z = (r * Math.sin(phi) * Math.sin(theta));
                const y = (r * Math.cos(phi));
                
                // ç®€å•çš„ç¬ç§»ï¼Œå®é™…é¡¹ç›®ä¸­å»ºè®®ç”¨ TWEEN.js è¡¥é—´åŠ¨ç”»
                this.camera.position.set(x, y, z);
                this.camera.lookAt(0, 0, 0);
                this.controls.update();
            },

            updateMarkers() {
                if(App.currentView !== 'earth') return;
                const tempV = new THREE.Vector3();
                
                for(const marker of this.markers) {
                    tempV.copy(marker.position);
                    // æ ‡è®°è·Ÿéšåœ°çƒæ—‹è½¬
                    tempV.applyMatrix4(this.earthGroup.matrixWorld);
                    
                    // åˆ¤æ–­å¯è§æ€§ (é®æŒ¡å‰”é™¤)
                    const cameraToEarth = this.camera.position.distanceTo(this.earthGroup.position);
                    const cameraToPoint = this.camera.position.distanceTo(tempV);
                    
                    // åªæœ‰å½“ç‚¹æ¯”åœ°çƒä¸­å¿ƒç¦»ç›¸æœºæ›´è¿‘æ—¶æ˜¾ç¤º (ç²—ç•¥)
                    // æˆ–è€…ä½¿ç”¨æ³•çº¿åˆ¤æ–­ï¼š
                    const vNormal = tempV.clone().sub(this.earthGroup.position).normalize();
                    const vView = this.camera.position.clone().sub(this.earthGroup.position).normalize();
                    const dot = vNormal.dot(vView);

                    if(dot > 0.2) { 
                        // è½¬å±å¹•åæ ‡
                        tempV.project(this.camera);
                        const x = (tempV.x * .5 + .5) * window.innerWidth;
                        const y = (tempV.y * -.5 + .5) * window.innerHeight;
                        
                        marker.element.style.transform = `translate(-50%, -100%) translate(${x}px, ${y-10}px)`;
                        marker.element.classList.add('visible');
                    } else {
                        marker.element.classList.remove('visible');
                    }
                }
            },

            switchScene(name) {
                this.activeScene = this.scenes[name];
                const labels = document.getElementById('earth-labels-container');
                
                if(name === 'earth') {
                    this.controls.enabled = true;
                    this.renderer.domElement.style.pointerEvents = 'all'; 
                    labels.style.display = 'block';
                    // è‡ªåŠ¨æ—‹è½¬ä¸€ç‚¹å¢åŠ åŠ¨æ€æ„Ÿ
                } else {
                    this.controls.enabled = false;
                    this.camera.position.set(0, 0, 12);
                    this.camera.lookAt(0,0,0);
                    this.renderer.domElement.style.pointerEvents = 'none'; 
                    labels.style.display = 'none';
                }
            },

            animate() {
                requestAnimationFrame(() => this.animate());
                
                if (App.currentView === 'dashboard') {
                    if(this.particles) this.particles.rotation.y += 0.001;
                } else {
                    this.controls.update();
                    // åœ°çƒè‡ªè½¬ (å¦‚æœç”¨æˆ·æ²¡åœ¨æ‹–æ‹½)
                    // this.earthGroup.rotation.y += 0.0005;
                    this.updateMarkers();
                    
                    // ç®€å•çš„äº‘å±‚ç§»åŠ¨æ•ˆæœï¼ˆå¦‚æœæœ‰ç‹¬ç«‹äº‘å±‚Meshï¼‰
                }
                this.renderer.render(this.activeScene, this.camera);
            },
            
            onResize() {
                this.camera.aspect = window.innerWidth / window.innerHeight;
                this.camera.updateProjectionMatrix();
                this.renderer.setSize(window.innerWidth, window.innerHeight);
            }
        };

        /**
         * æ°”è±¡ä¸ä¸šåŠ¡æ ¸å¿ƒ
         */
        const WeatherCore = {
            init() {
                document.getElementById('city-input').addEventListener('keypress', (e) => {
                    if(e.key === 'Enter') this.search();
                });
                this.fetchWeather('Beijing');
            },

            async search() {
                const city = document.getElementById('city-input').value.trim();
                if(city) this.fetchWeather(city);
            },

            async fetchWeather(city) {
                try {
                    // 1. è·å–åæ ‡
                    const geoRes = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(city)}&count=1&language=zh&format=json`).then(r=>r.json());
                    if(!geoRes.results || geoRes.results.length === 0) throw new Error("æœªæ‰¾åˆ°åŸå¸‚");
                    
                    const { latitude, longitude, name } = geoRes.results[0];
                    App.targetCityCoords = { lat: latitude, lon: longitude };

                    // 2. è·å–çœŸå®å¤©æ°”
                    const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m,relative_humidity_2m,apparent_temperature,is_day,precipitation,weather_code,wind_speed_10m&daily=weather_code,temperature_2m_max,temperature_2m_min,precipitation_sum,uv_index_max&timezone=auto&forecast_days=7`;
                    const weatherData = await fetch(weatherUrl).then(r=>r.json());

                    // 3. è¿æ¥æˆ‘ä»¬çš„ Python åç«¯è·å– AI åˆ†æå’Œæ¨è
                    // æ³¨æ„ï¼šè¿™é‡Œéœ€è¦ Python åç«¯è¿è¡Œã€‚å¦‚æœä¸è¿è¡Œï¼Œä½¿ç”¨ Mock æ•°æ®ã€‚
                    let aiData = null;
                    try {
                        const aiRes = await fetch(`http://127.0.0.1:5000/api/analyze?city=${name}`);
                        if(aiRes.ok) aiData = await aiRes.json();
                    } catch(e) {
                        console.warn("åç«¯è¿æ¥å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°å…œåº•é€»è¾‘", e);
                        // æœ¬åœ°å…œåº•æ•°æ®ç»“æ„
                        aiData = {
                            travel: {
                                food: [{name:"Local Food", desc:"Connect backend for details", icon:"ğŸ²"}],
                                spots: [{name:"Local Spot", desc:"Connect backend for details", tag:"View"}]
                            },
                            advice: "åç«¯ç¦»çº¿æ¨¡å¼ï¼šè¯·ç¡®ä¿ app.py å·²è¿è¡Œã€‚"
                        };
                    }

                    this.renderUI(name, weatherData, aiData);
                    CNNSimulator.run(weatherData.daily.temperature_2m_max);

                } catch(e) {
                    alert("è·å–æ•°æ®å¤±è´¥ï¼š" + e.message);
                }
            },

            renderUI(name, wData, aiData) {
                const current = wData.current;
                
                // åŸºç¡€å¤©æ°”
                document.getElementById('city-name').textContent = name;
                document.getElementById('current-date').textContent = new Date().toLocaleDateString('zh-CN', {weekday:'long', month:'short', day:'numeric'});
                document.getElementById('temp-val').textContent = Math.round(current.temperature_2m) + 'Â°';
                document.getElementById('weather-desc').textContent = this.getWeatherDesc(current.weather_code);
                document.getElementById('humidity').textContent = current.relative_humidity_2m + '%';
                document.getElementById('wind').textContent = current.wind_speed_10m + ' km/h';

                // AI å»ºè®®
                document.getElementById('suggestion-desc').textContent = aiData ? aiData.advice : "æ­£åœ¨åˆ†ææ°”è±¡æ•°æ®...";

                // æ—…æ¸¸æ¨èæ¸²æŸ“
                if(aiData && aiData.travel) {
                    const foodList = document.getElementById('food-list');
                    const spotList = document.getElementById('spot-list');
                    
                    foodList.innerHTML = aiData.travel.food.map(f => `
                        <div class="flex items-start gap-3 p-2 hover:bg-white/5 rounded-lg transition">
                            <div class="text-2xl">${f.icon}</div>
                            <div>
                                <div class="font-bold text-sm text-white">${f.name}</div>
                                <div class="text-xs text-gray-400">${f.desc}</div>
                            </div>
                        </div>
                    `).join('');

                    spotList.innerHTML = aiData.travel.spots.map(s => `
                        <div class="flex items-center justify-between p-2 hover:bg-white/5 rounded-lg transition">
                            <div>
                                <div class="font-bold text-sm text-white">${s.name}</div>
                                <div class="text-xs text-gray-400">${s.desc}</div>
                            </div>
                            <span class="text-[10px] border border-green-500/30 text-green-400 px-2 py-0.5 rounded">${s.tag}</span>
                        </div>
                    `).join('');
                }
            },

            getWeatherDesc(code) {
                const map = { 0:'æ™´æœ—', 1:'å¤šäº‘', 2:'é˜´å¤©', 3:'é˜´', 45:'é›¾', 51:'å°é›¨', 61:'é›¨', 63:'å¤§é›¨', 71:'é›ª', 95:'é›·æš´' };
                return map[code] || 'æœªçŸ¥';
            }
        };

        const CNNSimulator = {
            run(historyTemps) {
                const inputContainer = document.getElementById('cnn-input');
                const outContainer = document.getElementById('cnn-output');
                
                // æ¸…ç†æ—§å…ƒç´  (ä¿ç•™ kernel)
                Array.from(inputContainer.children).forEach(c => {
                    if(!c.classList.contains('cnn-kernel')) c.remove();
                });
                outContainer.innerHTML = '';

                // è¾“å…¥å±‚å¯è§†åŒ–
                const inputs = historyTemps.slice(0, 5); 
                const maxT = Math.max(...inputs, 35);
                
                inputs.forEach(t => {
                    const h = (t / maxT) * 100;
                    const bar = document.createElement('div');
                    bar.className = 'flex-1 bg-blue-500/40 hover:bg-blue-400 rounded-sm mx-0.5 relative transition-all duration-300';
                    bar.style.height = `${h}%`;
                    inputContainer.appendChild(bar);
                });

                // è¾“å‡ºå±‚å¯è§†åŒ–
                setTimeout(() => {
                    for(let i=0; i<5; i++) {
                        const pred = Math.round(inputs[inputs.length-1] + (Math.random()-0.5)*4);
                        const div = document.createElement('div');
                        div.className = 'bg-white/5 rounded p-1 flex flex-col items-center justify-center opacity-0 border border-white/5';
                        div.style.animation = `fadeScale 0.4s ease forwards ${0.5 + i*0.1}s`;
                        div.innerHTML = `
                            <span class="text-[10px] text-gray-500">+${i+1}d</span>
                            <span class="font-bold text-blue-300 text-sm">${pred}Â°</span>
                        `;
                        outContainer.appendChild(div);
                    }
                }, 800);
            }
        };

        const SuggestionBox = {
            modal: document.getElementById('suggestion-modal'),
            content: document.getElementById('suggestion-content'),
            open() {
                this.modal.classList.remove('hidden');
                setTimeout(() => {
                    this.content.classList.remove('scale-95', 'opacity-0');
                    this.content.classList.add('scale-100', 'opacity-100');
                }, 10);
            },
            close() {
                this.content.classList.remove('scale-100', 'opacity-100');
                this.content.classList.add('scale-95', 'opacity-0');
                setTimeout(() => this.modal.classList.add('hidden'), 300);
            },
            submit() {
                const btn = document.querySelector('#suggestion-content button:last-child');
                btn.textContent = "å‘é€æˆåŠŸ";
                btn.classList.add('bg-green-600');
                setTimeout(() => {
                    this.close();
                    setTimeout(() => {
                        btn.textContent = "æäº¤å»ºè®®";
                        btn.classList.remove('bg-green-600');
                    }, 500);
                }, 800);
            }
        };

        const GestureCtrl = {
            toggle() {
                alert("æ‘„åƒå¤´æ‰‹åŠ¿æ¨¡å—éœ€ HTTPS ç¯å¢ƒæ”¯æŒã€‚\n(Mock: å·²å¼€å¯æ‰‹åŠ¿è¿½è¸ª)");
            }
        };

        window.addEventListener('load', () => App.init());

    </script>
</body>
</html>

